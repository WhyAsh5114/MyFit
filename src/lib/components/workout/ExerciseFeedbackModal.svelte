<script lang="ts">
	import MyModal from '../MyModal.svelte';

	export let workoutExercises: WorkoutExercise[];
	export let feedbackTaken: boolean[];
	export let exerciseFeedbackModal: HTMLDialogElement;
	export let selectedExercise: WorkoutExercise | undefined;
	export let muscleWorkloads: Workout['muscleGroupWorkloads'];
	export let musclesTargetedPreviously: MuscleSorenessData[];
	export let workoutPerformed = false;

	const ratingMap: Record<number, string> = { 0: 'none', 1: 'moderate', 2: 'high' };
	const workloadMap: Record<number, string> = { 0: 'low', 1: 'moderate', 2: 'high' };
	const colorMap = ['checked:!bg-success', 'checked:!bg-warning', 'checked:!bg-error'];

	let feedbackSystem: Record<string, Record<string, string>> = {
		'Joint pain rating': {
			'No pain': colorMap[0],
			'Some pain': colorMap[1],
			'That hurt': colorMap[2]
		},
		'Pump rating': {
			'No pump': colorMap[2],
			'Decent pump': colorMap[1],
			'Amazing pump': colorMap[0]
		}
	};

	let feedbackValues: Record<string, 'none' | 'moderate' | 'high' | undefined>;
	$: setFeedbackValues(selectedExercise);
	function setFeedbackValues(selectedExercise: WorkoutExercise | undefined) {
		feedbackValues = {
			'Joint pain rating': selectedExercise?.jointPainRating,
			'Pump rating': selectedExercise?.pumpRating
		};
	}

	let sorenessDataField: MuscleSorenessData | undefined;
	export function openWorkloadAndSorenessModal() {
		let totalExercisesForTargetMuscle: number[] = [];
		workoutExercises.forEach((exercise, i) => {
			if (exercise.muscleTarget === selectedExercise?.muscleTarget) {
				totalExercisesForTargetMuscle.push(i);
			}
		});
		let feedbacksRemainingForTargetMuscle = totalExercisesForTargetMuscle.length;
		totalExercisesForTargetMuscle.forEach((exerciseIdx) => {
			if (feedbackTaken[exerciseIdx]) {
				feedbacksRemainingForTargetMuscle--;
			}
		});

		sorenessDataField = musclesTargetedPreviously.find((x) => x.muscleTarget === selectedExercise?.muscleTarget);
		if (sorenessDataField?.workoutIndex === undefined) {
			sorenessDataField = undefined;
		}

		if (feedbacksRemainingForTargetMuscle === 0) {
			workloadAndSorenessModal.show();
		}
	}

	function syncExerciseFeedback() {
		if (!selectedExercise) {
			return;
		}

		selectedExercise.jointPainRating = feedbackValues['Joint pain rating'];
		selectedExercise.pumpRating = feedbackValues['Pump rating'];
	}

	let workloadAndSorenessModal: HTMLDialogElement;
</script>

{#if selectedExercise}
	<MyModal
		bind:dialogElement={workloadAndSorenessModal}
		title={`${selectedExercise?.muscleTarget} workload rating`}
		titleColor="text-accent"
	>
		<p>
			How much was the workload {#if sorenessDataField}<span>& soreness</span>{/if} for the
			<span class="font-semibold italic">{selectedExercise.muscleTarget}</span> muscles in this workout?
		</p>
		<div class="h-px w-full bg-secondary mt-2 mb-4" />
		<form
			class="flex flex-col gap-2"
			on:submit|preventDefault={() => {
				workloadAndSorenessModal.close();
			}}
		>
			<div class="flex flex-col">
				<h3 class="font-semibold mt-2">Workload rating</h3>
				<div class="grid grid-cols-3 gap-1 mt-1">
					{#each [["Could've done more", colorMap[1]], ['Just right', colorMap[0]], ['Too much work', colorMap[2]]] as choice, i}
						<input
							class="btn checked:!text-black {choice[1]}"
							type="radio"
							name="Workload rating"
							aria-label={choice[0]}
							bind:group={muscleWorkloads[selectedExercise.muscleTarget]}
							value={workloadMap[i]}
						/>
					{/each}
				</div>
			</div>
			{#if sorenessDataField}
				<div class="flex flex-col">
					<h3 class="font-semibold mt-2">Soreness rating</h3>
					<div class="grid grid-cols-3 gap-1 mt-1">
						{#each [['none', colorMap[1]], ['recovered on time', colorMap[0]], ['interfered with workout', colorMap[2]]] as choice}
							<input
								class="btn checked:!text-black {choice[1]}"
								type="radio"
								name="Soreness rating"
								aria-label={choice[0]}
								bind:group={sorenessDataField.sorenessRating}
								value={choice[0]}
							/>
						{/each}
					</div>
				</div>
			{/if}
			<button class="btn btn-block mt-2 btn-accent"> Submit feedback </button>
		</form>
	</MyModal>
{/if}

<MyModal
	bind:dialogElement={exerciseFeedbackModal}
	title="Exercise feedback"
	titleColor="text-accent"
	onClose={() => {
		if (!workoutPerformed) openWorkloadAndSorenessModal();
	}}
>
	<p>
		Rate <span class="font-semibold italic">{selectedExercise?.name}</span> for appropriate adjustments in the next week
	</p>
	<div class="h-px w-full bg-secondary mt-2 mb-4" />
	<form class="flex flex-col gap-2" on:submit|preventDefault={syncExerciseFeedback}>
		{#each Object.keys(feedbackSystem) as item}
			<div class="flex flex-col">
				<h3 class="font-semibold">{item}</h3>
				<div class="grid grid-cols-3 gap-1 mt-1">
					{#each Object.keys(feedbackSystem[item]) as choice, i}
						<input
							class="btn checked:!text-black {feedbackSystem[item][choice]}"
							type="radio"
							name={item}
							aria-label={choice}
							bind:group={feedbackValues[item]}
							value={ratingMap[i]}
							on:change={syncExerciseFeedback}
						/>
					{/each}
				</div>
			</div>
		{/each}
		<button
			class="btn btn-block mt-2 btn-accent"
			on:click={() => {
				exerciseFeedbackModal.close();
			}}
		>
			Submit feedback
		</button>
	</form>
</MyModal>
